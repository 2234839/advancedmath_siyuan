name: Build and Deploy
on: [push]
permissions:
  contents: write
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: mkdir tmp
        run: |
          [ -d "./tmp" ] || mkdir ./tmp
          [ -d "./tmp/wd" ] || mkdir ./tmp/wd

      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: ğŸ“–ä¸‹è½½ç¬”è®°æœ¬æºæ–‡ä»¶ï¼ˆå¦‚æœé€šè¿‡githubä¸Šä¼ åˆ™å¯ä»¥ç›´æ¥é€šè¿‡ä¸Šæ–¹çš„ Checkout æ¥è·å–ï¼Œè¿™é‡Œæ¼”ç¤ºä»ç½‘ç»œè·å–ï¼‰
        run: |
          cd ./tmp
          ZIP_NAME="advancedmath.sy.zip"
          LATEST_VERSION_TAG=$(curl -s "https://api.github.com/repos/tritium333/advancedmath_siyuan/releases" | jq -r '.[0].tag_name')
          [ -f $ZIP_NAME ] || curl -LO "https://github.com/tritium333/advancedmath_siyuan/releases/download/$LATEST_VERSION_TAG/$ZIP_NAME"
          [ -d é«˜ç­‰æ•°å­¦ ] || unzip $ZIP_NAME

      - name: ğŸŒŠä¸‹è½½OceanPress
        run: |
          cd ./tmp
          [ -d oceanpress ] || git clone https://github.com/siyuan-note/oceanpress.git
          cd  ./oceanpress
          git pull
          cd ./apps/frontend/
          [ command -v <pnpm> ] || npm i -g pnpm
          pnpm install

      - name: ğŸ’½ä¸‹è½½æ€æºç¨‹åºå¹¶è¿è¡Œ
        run: |
          cd ./tmp
          # è·å–æ€æºæœ€æ–°å‘å¸ƒçš„ç‰ˆæœ¬å·
          LATEST_VERSION_TAG=$(curl --silent "https://api.github.com/repos/siyuan-note/siyuan/releases/latest" | grep -Po '"tag_name": "\K.*?(?=")')
          LATEST_VERSION=${LATEST_VERSION_TAG#v}  # å»é™¤å‰ç¼€ "v"
          SIYUAN_FILE_ZIP_NAME="siyuan-$LATEST_VERSION-linux.tar.gz"
          # ä¸‹è½½å¹¶è§£å‹æ€æºæœ€æ–°ç‰ˆæœ¬
          [ -f $SIYUAN_FILE_ZIP_NAME ] || curl -LO "https://github.com/siyuan-note/siyuan/releases/latest/download/$SIYUAN_FILE_ZIP_NAME"
          SIYUAN_DIR="siyuan-$LATEST_VERSION-linux"
          [ -d $SIYUAN_DIR ] || tar -xzf $SIYUAN_FILE_ZIP_NAME
          cd $SIYUAN_DIR
          # è¿è¡Œç¨‹åºåˆå§‹åŒ–å·¥ä½œç©ºé—´
          [ -d ../wd/data ] || (timeout -s SIGINT 5s ./resources/kernel/SiYuan-Kernel -wd ./resources/ -workspace ../wd -accessAuthCode 123456789 -alsologtostderr ./err.log -lang zh_CN -log_dir ./ &) && sleep 10
          # å¤åˆ¶ä¸€ä¸ªé¢„è®¾çš„ç©ºç¬”è®°æœ¬è¿‡æ¥,å¦‚æœæœ¬æ¥å°±ä¸Šä¼ çš„æ˜¯ç¬”è®°æœ¬è€Œéå¯¼å‡ºçš„ zip æ–‡ä»¶çš„è¯å°±ä¸ç”¨è¿™ä¹ˆéº»çƒ¦ã€‚
          cp -Rf ../../.github/workflows/20240131230752-d628ux0 ../wd/data
          # å¤åˆ¶ç¬”è®°
          cp -Rf ../é«˜ç­‰æ•°å­¦/* ../wd/data/20240131230752-d628ux0
          ./resources/kernel/SiYuan-Kernel -wd ./resources/ -workspace ../wd -accessAuthCode 1234 -alsologtostderr ./err.log -lang zh_CN -log_dir ./ &
          sleep 10
          # è¯»å–å·¥ä½œç©ºé—´çš„ token ä¸”æ›´æ–° oceanpress.json å†™åˆ°ä¸´æ—¶æ–‡ä»¶
          TOKEN=$(jq -r '.api.token' ../wd/conf/conf.json)
          jq --arg token "$TOKEN" '.website.authorized = $token' ../../.github/workflows/oceanpress.json > ../temp.json
          # ç¼–è¯‘è¾“å‡º
          cd ../oceanpress/apps/frontend
          pnpm cli build -c ../../../../tmp/temp.json -o ../../../../tmp/output

      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: ./tmp/output # The folder the action should deploy.